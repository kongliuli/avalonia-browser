# 修复编译错误并实现功能点1、2、3的完整计划

## 一、编译错误修复

### 1.1 修复 using 指令缺失

**问题**：所有 Repository 文件缺少必要的 using 指令

**修复方案**：
1. 在所有 Repository 文件顶部添加：
   ```csharp
   using Microsoft.Data.Sqlite;
   using Dapper;
   using System.Threading.Tasks;
   ```

**影响的文件**：
- BookmarkFolderRepository.cs
- BookmarkRepository.cs
- BrowsingHistoryRepository.cs
- UserSettingsRepository.cs

### 1.2 修复方法返回值

**问题**：很多 async void 方法没有返回值

**修复方案**：
1. 将 `async void` 改为 `async Task`
2. 在方法末尾添加 `return;`

**影响的方法**：
- BookmarkService.AddAsync, UpdateAsync, DeleteAsync, DeleteAllAsync, MoveToFolderAsync
- BrowsingHistoryService.AddVisitAsync, ClearAsync
- UserSettingsService.SetAsync, SetHomePageAsync, SetSearchEngineAsync, SetThemeAsync
- DatabaseService.InitializeAsync

### 1.3 修复命名空间问题

**问题**：SqliteConnection 应该是 SqliteConnection

**修复方案**：将所有 `SqliteConnection` 替换为 `SqliteConnection`

## 二、功能点实现

### 2.1 功能点1：浏览历史管理

**目标**：实现完整的浏览历史功能

**实现内容**：
1. 在 MainViewModel 中添加浏览历史集合
2. 添加显示/隐藏历史面板命令
3. 添加清除历史命令
4. 添加搜索历史命令
5. 在 UI 中添加历史记录列表
6. 集成 BrowsingHistoryService

**UI 组件**：
- 历史记录面板（ListBox）
- 搜索框
- 清除按钮
- 历史项双击导航

### 2.2 功能点2：书签管理

**目标**：实现完整的书签管理功能

**实现内容**：
1. 在 MainViewModel 中添加书签集合
2. 添加书签文件夹集合
3. 添加显示/隐藏书签面板命令
4. 添加添加书签命令
5. 添加删除书签命令
6. 添加移动书签到文件夹命令
7. 在 UI 中添加书签管理面板
8. 集成 BookmarkService 和 BookmarkFolderService

**UI 组件**：
- 书签面板（TreeView）
- 书签列表
- 文件夹树
- 添加书签按钮
- 右键菜单

### 2.3 功能点3：用户设置

**目标**：实现完整的用户设置功能

**实现内容**：
1. 在 MainViewModel 中添加用户设置属性
2. 添加主页设置命令
3. 添加搜索引擎设置命令
4. 添加主题切换命令
5. 在 UI 中添加设置面板
6. 集成 UserSettingsService

**UI 组件**：
- 设置面板（Grid）
- 主页设置（TextBox + Button）
- 搜索引擎选择（ComboBox）
- 主题切换（RadioButton）
- 其他设置（CheckBox）

## 三、单元测试

### 3.1 创建测试项目

**测试内容**：
1. Repository 层测试
   - 测试 CRUD 操作
   - 测试查询功能
   - 测试并发访问

2. Service 层测试
   - 测试业务逻辑
   - 测试错误处理
   - 测试数据验证

3. ViewModel 层测试
   - 测试命令执行
   - 测试属性通知
   - 测试数据绑定

## 四、实施步骤

### 阶段一：修复编译错误（30 分钟）

- [ ] 1.1 修复所有 Repository 文件的 using 指令
- [ ] 1.2 修复所有 Service 文件的方法返回值
- [ ] 1.3 修复命名空间问题
- [ ] 1.4 运行 `dotnet build` 验证修复

### 阶段二：实现功能点1（1-2 小时）

- [ ] 2.1 更新 MainViewModel 添加历史相关属性和命令
- [ ] 2.2 创建历史记录面板 UI
- [ ] 2.3 集成 BrowsingHistoryService
- [ ] 2.4 测试浏览历史功能

### 阶段三：实现功能点2（1-2 小时）

- [ ] 3.1 更新 MainViewModel 添加书签相关属性和命令
- [ ] 3.2 创建书签管理面板 UI
- [ ] 3.3 集成 BookmarkService 和 BookmarkFolderService
- [ ] 3.4 测试书签管理功能

### 阶段四：实现功能点3（1 小时）

- [ ] 4.1 更新 MainViewModel 添加设置相关属性和命令
- [ ] 4.2 创建设置面板 UI
- [ ] 4.3 集成 UserSettingsService
- [ ] 4.4 测试用户设置功能

### 阶段五：创建单元测试（1 小时）

- [ ] 5.1 创建 Repository 测试
- [ ] 5.2 创建 Service 测试
- [ ] 5.3 创建 ViewModel 测试
- [ ] 5.4 运行所有测试

### 阶段六：最终验证（30 分钟）

- [ ] 6.1 运行 `dotnet build` 确保无错误
- [ ] 6.2 运行应用测试所有功能
- [ ] 6.3 更新文档说明新功能
- [ ] 6.4 清理临时文件

## 五、预期成果

### 编译状态
- ✅ 所有编译错误已修复
- ✅ 所有警告已消除
- ✅ 项目可以正常编译和运行

### 功能完整度
- ✅ 浏览历史管理完整
- ✅ 书签管理完整
- ✅ 用户设置完整
- ✅ 所有功能与数据层正确集成

### 代码质量
- ✅ 遵循 C# 编码规范
- ✅ 所有方法都有适当的返回值
- ✅ 所有必要的 using 指令都已添加
- ✅ 代码注释清晰

### 测试覆盖
- ✅ Repository 层有单元测试
- ✅ Service 层有单元测试
- ✅ ViewModel 层有单元测试
- ✅ 所有功能都经过测试验证

## 六、风险和挑战

### 技术风险
- ⚠️ 数据库并发访问可能需要优化
- ⚠️ 大量历史记录可能影响性能
- ⚠️ UI 更新可能影响现有功能

### 缓解策略
- 分阶段实施，每个阶段独立验证
- 保留现有功能，逐步添加新功能
- 每个阶段完成后运行测试

---

**预计总时间**：4-5 小时  
**优先级**：高  
**状态**：待确认
